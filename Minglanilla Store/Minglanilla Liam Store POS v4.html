<script type="text/javascript">
        var gk_isXlsx = false;
        var gk_xlsxFileLookup = {};
        var gk_fileData = {};
        function filledCell(cell) {
          return cell !== '' && cell != null;
        }
        function loadFileData(filename) {
        if (gk_isXlsx && gk_xlsxFileLookup[filename]) {
            try {
                var workbook = XLSX.read(gk_fileData[filename], { type: 'base64' });
                var firstSheetName = workbook.SheetNames[0];
                var worksheet = workbook.Sheets[firstSheetName];

                // Convert sheet to JSON to filter blank rows
                var jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1, blankrows: false, defval: '' });
                // Filter out blank rows (rows where all cells are empty, null, or undefined)
                var filteredData = jsonData.filter(row => row.some(filledCell));

                // Heuristic to find the header row by ignoring rows with fewer filled cells than the next row
                var headerRowIndex = filteredData.findIndex((row, index) =>
                  row.filter(filledCell).length >= filteredData[index + 1]?.filter(filledCell).length
                );
                // Fallback
                if (headerRowIndex === -1 || headerRowIndex > 25) {
                  headerRowIndex = 0;
                }

                // Convert filtered JSON back to CSV
                var csv = XLSX.utils.aoa_to_sheet(filteredData.slice(headerRowIndex)); // Create a new sheet from filtered array of arrays
                csv = XLSX.utils.sheet_to_csv(csv, { header: 1 });
                return csv;
            } catch (e) {
                console.error(e);
                return "";
            }
        }
        return gk_fileData[filename] || "";
        }
        </script><!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sales Management System with POS</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            max-width: 1200px;
            margin: 0 auto;
        }
        h1, h2 {
            color: #333;
        }
        .section {
            margin: 20px 0;
            padding: 20px;
            border: 1px solid #ccc;
            border-radius: 5px;
        }
        .form-group {
            margin-bottom: 15px;
        }
        label {
            display: inline-block;
            width: 100px;
        }
        input, select {
            padding: 5px;
            width: 200px;
        }
        button {
            padding: 8px 16px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        button:hover {
            background-color: #0056b3;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        th {
            background-color: #f2f2f2;
        }
        .summary {
            display: flex;
            gap: 20px;
            margin-top: 20px;
            flex-wrap: wrap;
        }
        .summary div {
            padding: 10px;
            background-color: #e9ecef;
            border-radius: 4px;
            min-width: 150px;
        }
        .pos-container {
            display: flex;
            gap: 20px;
        }
        .pos-products, .pos-cart {
            flex: 1;
        }
        .pos-products table {
            cursor: pointer;
        }
        .pos-cart .total {
            font-weight: bold;
            margin-top: 10px;
        }
        .admin-section {
            display: none;
        }
        .pos-section {
            display: block;
        }
        .toggle-button {
            position: fixed;
            top: 20px;
            right: 20px;
        }
        .search-bar {
            margin-bottom: 15px;
        }
        .search-bar input {
            width: 100%;
            max-width: 300px;
        }
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            justify-content: center;
            align-items: center;
        }
        .modal-content {
            background-color: white;
            padding: 20px;
            border-radius: 5px;
            width: 400px;
        }
        .modal-content h3 {
            margin-top: 0;
        }
        .modal-content .form-group {
            margin-bottom: 15px;
        }
        .modal-content button {
            margin-right: 10px;
        }
        .delete-button {
            background-color: #dc3545;
        }
        .delete-button:hover {
            background-color: #c82333;
        }
    </style>
</head>
<body>
    <button class="toggle-button" onclick="toggleMode()">Switch to Admin Mode</button>
    <h1>Sales Management System with POS</h1>

    <!-- POS Section -->
    <div class="section pos-section" id="posSection">
        <h2>Point of Sale</h2>
        <div class="pos-container">
            <div class="pos-products">
                <h3>Products</h3>
                <div class="search-bar">
                    <input type="text" id="productSearch" placeholder="Search products by name or category" oninput="searchProducts()">
                </div>
                <table id="posProductsTable">
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Category</th>
                            <th>Price ($)</th>
                        </tr>
                    </thead>
                    <tbody id="posProductsTableBody"></tbody>
                </table>
            </div>
            <div class="pos-cart">
                <h3>Current Sale</h3>
                <table id="posCartTable">
                    <thead>
                        <tr>
                            <th>Product</th>
                            <th>Quantity</th>
                            <th>Price ($)</th>
                            <th>Total ($)</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody id="posCartTableBody"></tbody>
                </table>
                <div class="total">Total: $<span id="cartTotal">0.00</span></div>
                <button onclick="confirmSale()" style="margin-top: 10px;">Confirm Sale</button>
                <button onclick="clearCart()" style="margin-top: 10px; background-color: #dc3545;">Clear Cart</button>
            </div>
        </div>
    </div>

    <!-- Admin Sections -->
    <div class="section admin-section" id="adminProductSection">
        <h2>Add Product</h2>
        <div class="form-group">
            <label for="productId">Product ID:</label>
            <input type="text" id="productId" placeholder="e.g., P001">
        </div>
        <div class="form-group">
            <label for="productName">Name:</label>
            <input type="text" id="productName" placeholder="e.g., Widget">
        </div>
        <div class="form-group">
            <label for="productCategory">Category:</label>
            <input type="text" id="productCategory" placeholder="e.g., Electronics">
        </div>
        <div class="form-group">
            <label for="productPrice">Price ($):</label>
            <input type="number" id="productPrice" step="0.01" placeholder="e.g., 29.99">
        </div>
        <div class="form-group">
            <label for="productCostPrice">Cost Price ($):</label>
            <input type="number" id="productCostPrice" step="0.01" placeholder="e.g., 20.00">
        </div>
        <button onclick="addProductFromForm()">Add Product</button>
    </div>

    <div class="section admin-section" id="adminSaleSection">
        <h2>Add Sale (Admin)</h2>
        <div class="form-group">
            <label for="saleProductId">Product:</label>
            <select id="saleProductId">
                <option value="">Select Product</option>
            </select>
        </div>
        <div class="form-group">
            <label for="saleQuantity">Quantity:</label>
            <input type="number" id="saleQuantity" placeholder="e.g., 1" min="1">
        </div>
        <div class="form-group">
            <label for="salePrice">Sale Price ($):</label>
            <input type="number" id="salePrice" step="0.01" placeholder="e.g., 29.99">
        </div>
        <button onclick="addSaleFromForm()">Record Sale</button>
    </div>

    <div class="section admin-section" id="adminSummarySection">
        <h2>Financial Dashboard</h2>
        <div class="form-group">
            <label for="timeFilter">Filter by Time:</label>
            <select id="timeFilter" onchange="updateFinancialSummary()">
                <option value="all">All Time</option>
                <option value="week">This Week</option>
                <option value="month">This Month</option>
                <option value="year">This Year</option>
            </select>
        </div>
        <div class="summary">
            <div>Total Sales: $<span id="totalSales">0.00</span></div>
            <div>Total Revenue: $<span id="totalRevenue">0.00</span></div>
            <div>Gross Profit: $<span id="grossProfit">0.00</span></div>
            <div>Net Profit: $<span id="netProfit">0.00</span></div>
        </div>
    </div>

    <div class="section admin-section" id="adminSalesSection">
        <h2>Sales Records</h2>
        <div class="form-group">
            <label for="categoryFilter">Filter by Category:</label>
            <select id="categoryFilter" onchange="displaySales()">
                <option value="All">All</option>
            </select>
        </div>
        <table id="salesTable">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Product</th>
                    <th>Category</th>
                    <th>Quantity</th>
                    <th>Price ($)</th>
                    <th>Total ($)</th>
                    <th>Date</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody id="salesTableBody"></tbody>
        </table>
    </div>

    <!-- Edit Sale Modal -->
    <div id="editSaleModal" class="modal">
        <div class="modal-content">
            <h3>Edit Sale</h3>
            <div class="form-group">
                <label for="editSaleId">Sale ID:</label>
                <input type="text" id="editSaleId" readonly>
            </div>
            <div class="form-group">
                <label for="editSaleProductId">Product:</label>
                <select id="editSaleProductId">
                    <option value="">Select Product</option>
                </select>
            </div>
            <div class="form-group">
                <label for="editSaleQuantity">Quantity:</label>
                <input type="number" id="editSaleQuantity" min="1">
            </div>
            <div class="form-group">
                <label for="editSalePrice">Sale Price ($):</label>
                <input type="number" id="editSalePrice" step="0.01">
            </div>
            <button onclick="saveEditedSale()">Save Changes</button>
            <button onclick="closeEditModal()" style="background-color: #6c757d;">Cancel</button>
        </div>
    </div>

    <script>
        // Global variables
        let salesRecords = [];
        let products = [];
        let categories = ["All"];
        let totalIncome = 0;
        let totalRevenue = 0;
        let netProfit = 0;
        let grossProfit = 0;
        let cart = [];

        // Initial product list
        const initialProducts = [
            { id: "1", name: "baygon catol", price: 5, category: "Household", costPrice: 4 },
            { id: "2", name: "nova/piatos", price: 20, category: "Snacks", costPrice: 16 },
            { id: "3", name: "junkfoods", price: 10, category: "Snacks", costPrice: 8 },
            { id: "4", name: "happy", price: 2, category: "Snacks", costPrice: 1.6 },
            { id: "5", name: "lucky me canton", price: 15, category: "Noodles", costPrice: 12 },
            { id: "6", name: "lucky me noodles beef/chicken", price: 13, category: "Noodles", costPrice: 10.4 },
            { id: "7", name: "silver swan tuyo small pouch", price: 9, category: "Grocery", costPrice: 7.2 },
            { id: "8", name: "silver swan tuyo big pouch", price: 12, category: "Grocery", costPrice: 9.6 },
            { id: "9", name: "silver swan suka pouch", price: 10, category: "Grocery", costPrice: 8 },
            { id: "10", name: "mantika", price: 50, category: "Grocery", costPrice: 40 },
            { id: "11", name: "egg", price: 10, category: "Grocery", costPrice: 8 },
            { id: "12", name: "bihon", price: 25, category: "Noodles", costPrice: 20 },
            { id: "13", name: "family sardines green/red", price: 28, category: "Canned Goods", costPrice: 22.4 },
            { id: "14", name: "century tuna", price: 40, category: "Canned Goods", costPrice: 32 },
            { id: "15", name: "beef loaf", price: 30, category: "Canned Goods", costPrice: 24 },
            { id: "16", name: "corned beef holiday", price: 45, category: "Canned Goods", costPrice: 36 },
            { id: "17", name: "magic sarap", price: 5, category: "Seasoning", costPrice: 4 },
            { id: "18", name: "ginisa mix", price: 5, category: "Seasoning", costPrice: 4 },
            { id: "19", name: "vitsin ajinomoto", price: 5, category: "Seasoning", costPrice: 4 },
            { id: "20", name: "pepper", price: 10, category: "Seasoning", costPrice: 8 },
            { id: "21", name: "knorr cubes", price: 10, category: "Seasoning", costPrice: 8 },
            { id: "22", name: "knorr sinigang", price: 18, category: "Seasoning", costPrice: 14.4 },
            { id: "23", name: "mix laurel leaves", price: 30, category: "Seasoning", costPrice: 24 },
            { id: "24", name: "asuetes", price: 5, category: "Seasoning", costPrice: 4 },
            { id: "25", name: "brown sugar", price: 25, category: "Grocery", costPrice: 20 },
            { id: "26", name: "refined sugar white", price: 30, category: "Grocery", costPrice: 24 },
            { id: "27", name: "salt", price: 5, category: "Grocery", costPrice: 4 },
            { id: "28", name: "corn starch small", price: 3, category: "Grocery", costPrice: 2.4 },
            { id: "29", name: "corn starch big", price: 5, category: "Grocery", costPrice: 4 },
            { id: "30", name: "bombay whole", price: 12, category: "Grocery", costPrice: 9.6 },
            { id: "31", name: "ahos whole", price: 12, category: "Grocery", costPrice: 9.6 },
            { id: "32", name: "cup noodles", price: 30, category: "Noodles", costPrice: 24 },
            { id: "33", name: "spaghetti sauce", price: 48, category: "Pasta", costPrice: 38.4 },
            { id: "34", name: "tomato sauce", price: 30, category: "Pasta", costPrice: 24 },
            { id: "35", name: "tomato paste", price: 25, category: "Pasta", costPrice: 20 },
            { id: "36", name: "catsup", price: 16, category: "Condiments", costPrice: 12.8 },
            { id: "37", name: "kopico twin brown", price: 15, category: "Beverages", costPrice: 12 },
            { id: "38", name: "kopico twin blanka", price: 15, category: "Beverages", costPrice: 12 },
            { id: "39", name: "kopico twin black", price: 15, category: "Beverages", costPrice: 12 },
            { id: "40", name: "nescafe stick", price: 5, category: "Beverages", costPrice: 4 },
            { id: "41", name: "nescafe creamy white", price: 16, category: "Beverages", costPrice: 12.8 },
            { id: "42", name: "nescafe creamy latte", price: 16, category: "Beverages", costPrice: 12.8 },
            { id: "43", name: "energen", price: 10, category: "Beverages", costPrice: 8 },
            { id: "44", name: "milo", price: 12, category: "Beverages", costPrice: 9.6 },
            { id: "45", name: "bear brand swak", price: 13, category: "Beverages", costPrice: 10.4 },
            { id: "46", name: "tang juice orange/pineapple", price: 25, category: "Beverages", costPrice: 20 },
            { id: "47", name: "nestea juice apple", price: 25, category: "Beverages", costPrice: 20 },
            { id: "48", name: "condensed milk big", price: 52, category: "Dairy", costPrice: 41.6 },
            { id: "49", name: "condensed milk small", price: 46, category: "Dairy", costPrice: 36.8 },
            { id: "50", name: "angel evaporada", price: 45, category: "Dairy", costPrice: 36 },
            { id: "51", name: "green peas", price: 16, category: "Canned Goods", costPrice: 12.8 },
            { id: "52", name: "pineapple tidbits", price: 30, category: "Canned Goods", costPrice: 24 },
            { id: "53", name: "star margarine", price: 35, category: "Dairy", costPrice: 28 },
            { id: "54", name: "colgate", price: 8, category: "Toiletries", costPrice: 6.4 },
            { id: "55", name: "close up", price: 8, category: "Toiletries", costPrice: 6.4 },
            { id: "56", name: "ariel powder twin pack", price: 18, category: "Household", costPrice: 14.4 },
            { id: "57", name: "surf powder", price: 10, category: "Household", costPrice: 8 },
            { id: "58", name: "wings powder", price: 10, category: "Household", costPrice: 8 },
            { id: "59", name: "oyster sauce", price: 10, category: "Condiments", costPrice: 8 },
            { id: "60", name: "tide bar", price: 18, category: "Household", costPrice: 14.4 },
            { id: "61", name: "downy", price: 11, category: "Household", costPrice: 8.8 },
            { id: "62", name: "joy", price: 9, category: "Household", costPrice: 7.2 },
            { id: "63", name: "smart dishwashing liquid small", price: 15, category: "Household", costPrice: 12 },
            { id: "64", name: "smart dishwashing liquid big", price: 30, category: "Household", costPrice: 24 },
            { id: "65", name: "zonrox small", price: 15, category: "Household", costPrice: 12 },
            { id: "66", name: "zonrox big", price: 20, category: "Household", costPrice: 16 },
            { id: "67", name: "cheese", price: 23, category: "Dairy", costPrice: 18.4 },
            { id: "68", name: "panteen shampoo", price: 9, category: "Toiletries", costPrice: 7.2 },
            { id: "69", name: "sunsilk shampoo", price: 9, category: "Toiletries", costPrice: 7.2 },
            { id: "70", name: "dove shampoo", price: 9, category: "Toiletries", costPrice: 7.2 },
            { id: "71", name: "palmolive shampoo", price: 9, category: "Toiletries", costPrice: 7.2 },
            { id: "72", name: "head and shoulders", price: 9, category: "Toiletries", costPrice: 7.2 },
            { id: "73", name: "safeguard small", price: 25, category: "Toiletries", costPrice: 20 },
            { id: "74", name: "safeguard big", price: 30, category: "Toiletries", costPrice: 24 },
            { id: "75", name: "toothbrush", price: 35, category: "Toiletries", costPrice: 28 },
            { id: "76", name: "modess", price: 9, category: "Toiletries", costPrice: 7.2 },
            { id: "77", name: "sisters sanitary napkin", price: 9, category: "Toiletries", costPrice: 7.2 },
            { id: "78", name: "cotton buds", price: 8, category: "Toiletries", costPrice: 6.4 },
            { id: "79", name: "wipes", price: 22, category: "Toiletries", costPrice: 17.6 },
            { id: "80", name: "cotton small", price: 15, category: "Toiletries", costPrice: 12 },
            { id: "81", name: "cotton big", price: 25, category: "Toiletries", costPrice: 20 },
            { id: "82", name: "skyflakes biscuits", price: 9, category: "Snacks", costPrice: 7.2 },
            { id: "83", name: "fita", price: 9, category: "Snacks", costPrice: 7.2 },
            { id: "84", name: "rebisco", price: 9, category: "Snacks", costPrice: 7.2 },
            { id: "85", name: "hansel", price: 9, category: "Snacks", costPrice: 7.2 },
            { id: "86", name: "cheese cake", price: 11, category: "Snacks", costPrice: 8.8 },
            { id: "87", name: "candy/lollipop", price: 2, category: "Snacks", costPrice: 1.6 },
            { id: "88", name: "mineral water 500ml", price: 20, category: "Beverages", costPrice: 16 },
            { id: "89", name: "coke sakto", price: 15, category: "Beverages", costPrice: 12 },
            { id: "90", name: "coke mismo", price: 20, category: "Beverages", costPrice: 16 },
            { id: "91", name: "coke/sprite/orange litro", price: 44, category: "Beverages", costPrice: 35.2 },
            { id: "92", name: "sting/cobra", price: 25, category: "Beverages", costPrice: 20 },
            { id: "93", name: "c2", price: 15, category: "Beverages", costPrice: 12 },
            { id: "94", name: "yakult", price: 16, category: "Beverages", costPrice: 12.8 },
            { id: "95", name: "jelly c", price: 8, category: "Snacks", costPrice: 6.4 },
            { id: "96", name: "redhorse litro", price: 140, category: "Alcohol", costPrice: 112 },
            { id: "97", name: "marlboro blast", price: 10, category: "Tobacco", costPrice: 8 },
            { id: "98", name: "marlboro red", price: 10, category: "Tobacco", costPrice: 8 },
            { id: "99", name: "winston", price: 10, category: "Tobacco", costPrice: 8 },
            { id: "100", name: "mighty puti", price: 9, category: "Tobacco", costPrice: 7.2 },
            { id: "101", name: "misua", price: 4, category: "Noodles", costPrice: 3.2 },
            { id: "102", name: "odong", price: 4, category: "Noodles", costPrice: 3.2 },
            { id: "103", name: "butane", price: 30, category: "Household", costPrice: 24 },
            { id: "104", name: "stick o", price: 2, category: "Snacks", costPrice: 1.6 },
            { id: "105", name: "eden mayonnaise", price: 45, category: "Condiments", costPrice: 36 },
            { id: "106", name: "ladys choice mayonnaise", price: 45, category: "Condiments", costPrice: 36 },
            { id: "107", name: "colgate charcoal", price: 12, category: "Toiletries", costPrice: 9.6 },
            { id: "108", name: "gsm mojito", price: 170, category: "Alcohol", costPrice: 136 },
            { id: "109", name: "coke/sprite/orange 1.5", price: 75, category: "Beverages", costPrice: 60 },
            { id: "110", name: "perla soap", price: 23, category: "Toiletries", costPrice: 18.4 },
            { id: "111", name: "match", price: 5, category: "Household", costPrice: 4 }
        ];

        // Load data from localStorage
        function loadSalesRecords() {
            const savedRecords = localStorage.getItem('salesRecords');
            if (savedRecords) {
                salesRecords = JSON.parse(savedRecords);
            }
            
            const savedProducts = localStorage.getItem('products');
            if (savedProducts) {
                products = JSON.parse(savedProducts);
            } else {
                products = initialProducts;
                saveAllData();
            }
            
            updateCategories();
            
            const savedIncome = localStorage.getItem('totalIncome');
            if (savedIncome) {
                totalIncome = parseFloat(savedIncome);
            }
            
            const savedRevenue = localStorage.getItem('totalRevenue');
            if (savedRevenue) {
                totalRevenue = parseFloat(savedRevenue);
            }

            const savedNetProfit = localStorage.getItem('netProfit');
            if (savedNetProfit) {
                netProfit = parseFloat(savedNetProfit);
            }
            
            const savedGrossProfit = localStorage.getItem('grossProfit');
            if (savedGrossProfit) {
                grossProfit = parseFloat(savedGrossProfit);
            }

            updateUI();
        }

        // Save all data to localStorage
        function saveAllData() {
            localStorage.setItem('salesRecords', JSON.stringify(salesRecords));
            localStorage.setItem('products', JSON.stringify(products));
            localStorage.setItem('totalIncome', totalIncome.toString());
            localStorage.setItem('totalRevenue', totalRevenue.toString());
            localStorage.setItem('netProfit', netProfit.toString());
            localStorage.setItem('grossProfit', grossProfit.toString());
        }

        // Update categories
        function updateCategories() {
            categories = ["All", ...new Set(products.map(p => p.category))];
            const categoryFilter = document.getElementById('categoryFilter');
            categoryFilter.innerHTML = categories.map(cat => `<option value="${cat}">${cat}</option>`).join('');
        }

        // Add a new product
        function addProduct(product) {
            if (!product.id || !product.name || !product.category || !product.price || !product.costPrice) {
                alert("All product fields are required!");
                return false;
            }
            if (products.some(p => p.id === product.id)) {
                alert("Product ID must be unique!");
                return false;
            }
            products.push(product);
            updateCategories();
            saveAllData();
            updateProductDropdown();
            updatePosProducts();
            return true;
        }

        // Add product from form
        function addProductFromForm() {
            const product = {
                id: document.getElementById('productId').value,
                name: document.getElementById('productName').value,
                category: document.getElementById('productCategory').value,
                price: parseFloat(document.getElementById('productPrice').value),
                costPrice: parseFloat(document.getElementById('productCostPrice').value)
            };
            if (addProduct(product)) {
                document.getElementById('productId').value = '';
                document.getElementById('productName').value = '';
                document.getElementById('productCategory').value = '';
                document.getElementById('productPrice').value = '';
                document.getElementById('productCostPrice').value = '';
                alert("Product added successfully!");
            }
        }

        // Update product dropdown for admin sale form and edit modal
        function updateProductDropdown() {
            const saleDropdown = document.getElementById('saleProductId');
            const editDropdown = document.getElementById('editSaleProductId');
            const options = '<option value="">Select Product</option>' + 
                products.map(p => `<option value="${p.id}">${p.name} (${p.category})</option>`).join('');
            saleDropdown.innerHTML = options;
            editDropdown.innerHTML = options;
        }

        // Search products for POS
        function searchProducts() {
            const searchTerm = document.getElementById('productSearch').value.toLowerCase();
            const filteredProducts = products.filter(p => 
                p.name.toLowerCase().includes(searchTerm) || 
                p.category.toLowerCase().includes(searchTerm)
            );
            const tbody = document.getElementById('posProductsTableBody');
            tbody.innerHTML = filteredProducts.map(p => `
                <tr onclick="addToCart('${p.id}', 1)">
                    <td>${p.name}</td>
                    <td>${p.category}</td>
                    <td>${p.price.toFixed(2)}</td>
                </tr>
            `).join('');
        }

        // Update POS products table
        function updatePosProducts() {
            document.getElementById('productSearch').value = '';
            const tbody = document.getElementById('posProductsTableBody');
            tbody.innerHTML = products.map(p => `
                <tr onclick="addToCart('${p.id}', 1)">
                    <td>${p.name}</td>
                    <td>${p.category}</td>
                    <td>${p.price.toFixed(2)}</td>
                </tr>
            `).join('');
        }

        // Add to POS cart
        function addToCart(productId, quantity) {
            const product = products.find(p => p.id === productId);
            if (product) {
                const existingItem = cart.find(item => item.productId === productId);
                if (existingItem) {
                    existingItem.quantity += quantity;
                } else {
                    cart.push({ productId, quantity, price: product.price });
                }
                updateCartDisplay();
            } else {
                alert("Product not found!");
            }
        }

        // Update cart item quantity
        function updateCartItemQuantity(productId, quantity) {
            const item = cart.find(item => item.productId === productId);
            if (item) {
                item.quantity = parseInt(quantity) || 1;
                updateCartDisplay();
            }
        }

        // Remove item from cart
        function removeFromCart(productId) {
            cart = cart.filter(item => item.productId !== productId);
            updateCartDisplay();
        }

        // Update cart display
        function updateCartDisplay() {
            const tbody = document.getElementById('posCartTableBody');
            tbody.innerHTML = cart.map(item => {
                const product = products.find(p => p.id === item.productId);
                return `
                    <tr>
                        <td>${product ? product.name : 'Unknown'}</td>
                        <td><input type="number" value="${item.quantity}" min="1" onchange="updateCartItemQuantity('${item.productId}', this.value)"></td>
                        <td>${item.price.toFixed(2)}</td>
                        <td>${(item.price * item.quantity).toFixed(2)}</td>
                        <td><button onclick="removeFromCart('${item.productId}')" style="background-color: #dc3545;">Remove</button></td>
                    </tr>
                `;
            }).join('');
            updateCartTotal();
        }

        // Update cart total
        function updateCartTotal() {
            const total = cart.reduce((sum, item) => sum + item.price * item.quantity, 0);
            document.getElementById('cartTotal').textContent = total.toFixed(2);
        }

        // Clear cart
        function clearCart() {
            cart = [];
            updateCartDisplay();
        }

        // Confirm sale from POS
        function confirmSale() {
            if (cart.length === 0) {
                alert("Cart is empty!");
                return;
            }
            cart.forEach(item => {
                const sale = {
                    productId: item.productId,
                    quantity: item.quantity,
                    price: item.price
                };
                addSale(sale);
            });
            alert("Sale confirmed!");
            clearCart();
        }

        // Add a new sale
        function addSale(sale) {
            if (!sale.productId || !sale.quantity || !sale.price) {
                alert("All sale fields are required!");
                return false;
            }
            sale.id = Date.now().toString();
            sale.date = new Date().toISOString();
            salesRecords.push(sale);
            updateFinancials();
            displaySales();
            updateFinancialSummary();
            return true;
        }

        // Add sale from admin form
        function addSaleFromForm() {
            const sale = {
                productId: document.getElementById('saleProductId').value,
                quantity: parseInt(document.getElementById('saleQuantity').value),
                price: parseFloat(document.getElementById('salePrice').value)
            };
            if (addSale(sale)) {
                document.getElementById('saleProductId').value = '';
                document.getElementById('saleQuantity').value = '';
                document.getElementById('salePrice').value = '';
                alert("Sale recorded successfully!");
            }
        }

        // Recalculate financials from all sales records
        function updateFinancials() {
            totalRevenue = 0;
            totalIncome = 0;
            grossProfit = 0;
            netProfit = 0;

            salesRecords.forEach(sale => {
                const product = products.find(p => p.id === sale.productId);
                if (product) {
                    const salePrice = parseFloat(sale.price);
                    const costPrice = parseFloat(product.costPrice);
                    const quantity = parseInt(sale.quantity);
                    totalRevenue += salePrice * quantity;
                    totalIncome += salePrice * quantity;
                    grossProfit += (salePrice - costPrice) * quantity;
                    netProfit = grossProfit; // Assuming no additional expenses
                }
            });

            saveAllData();
        }

        // Edit sale
        function editSale(saleId) {
            const sale = salesRecords.find(s => s.id === saleId);
            if (sale) {
                document.getElementById('editSaleId').value = sale.id;
                document.getElementById('editSaleProductId').value = sale.productId;
                document.getElementById('editSaleQuantity').value = sale.quantity;
                document.getElementById('editSalePrice').value = sale.price;
                document.getElementById('editSaleModal').style.display = 'flex';
            }
        }

        // Save edited sale
        function saveEditedSale() {
            const saleId = document.getElementById('editSaleId').value;
            const saleIndex = salesRecords.findIndex(s => s.id === saleId);
            if (saleIndex !== -1) {
                const updatedSale = {
                    id: saleId,
                    productId: document.getElementById('editSaleProductId').value,
                    quantity: parseInt(document.getElementById('editSaleQuantity').value),
                    price: parseFloat(document.getElementById('editSalePrice').value),
                    date: salesRecords[saleIndex].date // Preserve original date
                };
                if (!updatedSale.productId || !updatedSale.quantity || !updatedSale.price) {
                    alert("All sale fields are required!");
                    return;
                }
                salesRecords[saleIndex] = updatedSale;
                updateFinancials();
                displaySales();
                updateFinancialSummary();
                closeEditModal();
                alert("Sale updated successfully!");
            }
        }

        // Close edit modal
        function closeEditModal() {
            document.getElementById('editSaleModal').style.display = 'none';
        }

        // Delete sale
        function deleteSale(saleId) {
            if (confirm("Are you sure you want to delete this sale?")) {
                salesRecords = salesRecords.filter(s => s.id !== saleId);
                updateFinancials();
                displaySales();
                updateFinancialSummary();
                alert("Sale deleted successfully!");
            }
        }

        // Get sales by category
        function getSalesByCategory(category) {
            if (category === "All") {
                return getFilteredSales();
            }
            return getFilteredSales().filter(sale => {
                const product = products.find(p => p.id === sale.productId);
                return product && product.category === category;
            });
        }

        // Get sales filtered by time period
        function getFilteredSales() {
            const timeFilter = document.getElementById('timeFilter').value;
            const now = new Date('2025-08-02T14:05:00-07:00'); // Current date: August 2, 2025, 2:05 PM PST

            if (timeFilter === 'all') {
                return salesRecords;
            }

            const startOfWeek = new Date(now);
            startOfWeek.setDate(now.getDate() - now.getDay() + (now.getDay() === 0 ? -6 : 1)); // Monday
            startOfWeek.setHours(0, 0, 0, 0);

            const startOfMonth = new Date(now.getFullYear(), now.getMonth(), 1);
            startOfMonth.setHours(0, 0, 0, 0);

            const startOfYear = new Date(now.getFullYear(), 0, 1);
            startOfYear.setHours(0, 0, 0, 0);

            return salesRecords.filter(sale => {
                const saleDate = new Date(sale.date);
                if (timeFilter === 'week') {
                    return saleDate >= startOfWeek && saleDate <= now;
                } else if (timeFilter === 'month') {
                    return saleDate >= startOfMonth && saleDate <= now;
                } else if (timeFilter === 'year') {
                    return saleDate >= startOfYear && saleDate <= now;
                }
                return true;
            });
        }

        // Update financial summary display
        function updateFinancialSummary() {
            const filteredSales = getFilteredSales();
            let totalSales = 0;
            let totalRevenue = 0;
            let grossProfit = 0;
            let netProfit = 0;

            filteredSales.forEach(sale => {
                const product = products.find(p => p.id === sale.productId);
                if (product) {
                    const salePrice = parseFloat(sale.price);
                    const costPrice = parseFloat(product.costPrice);
                    const quantity = parseInt(sale.quantity);
                    totalSales += salePrice * quantity;
                    totalRevenue += salePrice * quantity;
                    grossProfit += (salePrice - costPrice) * quantity;
                    netProfit = grossProfit; // Assuming no additional expenses
                }
            });

            document.getElementById('totalSales').textContent = totalSales.toFixed(2);
            document.getElementById('totalRevenue').textContent = totalRevenue.toFixed(2);
            document.getElementById('grossProfit').textContent = grossProfit.toFixed(2);
            document.getElementById('netProfit').textContent = netProfit.toFixed(2);
        }

        // Display sales records
        function displaySales() {
            const category = document.getElementById('categoryFilter').value;
            const sales = getSalesByCategory(category);
            const tbody = document.getElementById('salesTableBody');
            tbody.innerHTML = sales.map(sale => {
                const product = products.find(p => p.id === sale.productId);
                return `
                    <tr>
                        <td>${sale.id}</td>
                        <td>${product ? product.name : 'Unknown'}</td>
                        <td>${product ? product.category : 'Unknown'}</td>
                        <td>${sale.quantity}</td>
                        <td>${sale.price.toFixed(2)}</td>
                        <td>${(sale.price * sale.quantity).toFixed(2)}</td>
                        <td>${new Date(sale.date).toLocaleDateString()}</td>
                        <td>
                            <button onclick="editSale('${sale.id}')">Edit</button>
                            <button class="delete-button" onclick="deleteSale('${sale.id}')">Delete</button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // Update UI
        function updateUI() {
            updateProductDropdown();
            updateCategories();
            updateFinancialSummary();
            displaySales();
            updatePosProducts();
            updateCartDisplay();
        }

        // Toggle between POS and Admin modes
        function toggleMode() {
            const posSection = document.getElementById('posSection');
            const adminSections = document.querySelectorAll('.admin-section');
            const button = document.querySelector('.toggle-button');
            if (posSection.style.display === 'block') {
                posSection.style.display = 'none';
                adminSections.forEach(section => section.style.display = 'block');
                button.textContent = 'Switch to POS Mode';
            } else {
                posSection.style.display = 'block';
                adminSections.forEach(section => section.style.display = 'none');
                button.textContent = 'Switch to Admin Mode';
            }
        }

        // Initialize
        window.onload = loadSalesRecords;
    </script>
</body>
</html>